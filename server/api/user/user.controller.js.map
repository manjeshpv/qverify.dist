{"version":3,"sources":["api/user/user.controller.js"],"names":[],"mappings":"AAAA;;;;;;;;;AASA;;;;;QAsDgB,K,GAAA,K;QAOA,I,GAAA,I;QAYA,M,GAAA,M;QAQA,M,GAAA,M;QAgBA,O,GAAA,O;QAYA,K,GAAA,K;QAmCA,Q,GAAA,Q;QAeA,M,GAAA,M;QAQA,M,GAAA,M;QASA,E,GAAA,E;;AA9KhB;;;;AACA;;;;AACA;;;;AACA,IAAI,KAAK,QAAQ,iBAAR,CAAT;;AAEA,SAAS,iBAAT,CAA2B,GAA3B,EAAgC,UAAhC,EAA4C;AAC1C,eAAa,cAAc,GAA3B;AACA,SAAO,UAAU,MAAV,EAAkB;AACvB,QAAI,MAAJ,EAAY;AACV,UAAI,MAAJ,CAAW,UAAX,EAAuB,IAAvB,CAA4B,MAA5B;AACD;AACF,GAJD;AAKD;;AAED,SAAS,WAAT,CAAqB,OAArB,EAA8B;AAC5B,SAAO,UAAU,MAAV,EAAkB;AACvB,WAAO,OAAO,gBAAP,CAAwB,OAAxB,EACJ,IADI,CACC,mBAAW;AACf,aAAO,OAAP;AACD,KAHI,CAAP;AAID,GALD;AAMD;;AAED,SAAS,YAAT,CAAsB,GAAtB,EAA2B;AACzB,SAAO,UAAU,MAAV,EAAkB;AACvB,QAAI,MAAJ,EAAY;AACV,aAAO,OAAO,OAAP,GACJ,IADI,CACC,YAAM;AACV,YAAI,MAAJ,CAAW,GAAX,EAAgB,GAAhB;AACD,OAHI,CAAP;AAID;AACF,GAPD;AAQD;;AAED,SAAS,oBAAT,CAA8B,GAA9B,EAAmC;AACjC,SAAO,UAAU,MAAV,EAAkB;AACvB,QAAI,CAAC,MAAL,EAAa;AACX,UAAI,MAAJ,CAAW,GAAX,EAAgB,GAAhB;AACA,aAAO,IAAP;AACD;AACD,WAAO,MAAP;AACD,GAND;AAOD;;AAED,SAAS,WAAT,CAAqB,GAArB,EAA0B,UAA1B,EAAsC;AACpC,eAAa,cAAc,GAA3B;AACA,SAAO,UAAU,GAAV,EAAe;AACpB,QAAI,MAAJ,CAAW,UAAX,EAAuB,IAAvB,CAA4B,GAA5B;AACD,GAFD;AAGD;;AAED;AACO,SAAS,KAAT,CAAe,GAAf,EAAoB,GAApB,EAAyB;AAC9B,SAAO,YAAK,OAAL,GACJ,IADI,CACC,kBAAkB,GAAlB,CADD,EAEJ,KAFI,CAEE,YAAY,GAAZ,CAFF,CAAP;AAGD;;AAED;AACO,SAAS,IAAT,CAAc,GAAd,EAAmB,GAAnB,EAAwB;AAC7B,SAAO,YAAK,IAAL,CAAU;AACb,WAAO;AACL,WAAK,IAAI,MAAJ,CAAW;AADX;AADM,GAAV,EAKJ,IALI,CAKC,qBAAqB,GAArB,CALD,EAMJ,IANI,CAMC,kBAAkB,GAAlB,CAND,EAOJ,KAPI,CAOE,YAAY,GAAZ,CAPF,CAAP;AAQD;;AAED;AACO,SAAS,MAAT,CAAgB,GAAhB,EAAqB,GAArB,EAA0B;;AAE/B,SAAO,YAAK,MAAL,CAAY,IAAI,IAAhB,EACJ,IADI,CACC,kBAAkB,GAAlB,EAAuB,GAAvB,CADD,EAEJ,KAFI,CAEE,YAAY,GAAZ,CAFF,CAAP;AAGD;;AAED;AACO,SAAS,MAAT,CAAgB,GAAhB,EAAqB,GAArB,EAA0B;AAC/B,MAAI,IAAI,IAAJ,CAAS,GAAb,EAAkB;AAChB,WAAO,IAAI,IAAJ,CAAS,GAAhB;AACD;AACD,SAAO,YAAK,IAAL,CAAU;AACb,WAAO;AACL,WAAK,IAAI,MAAJ,CAAW;AADX;AADM,GAAV,EAKJ,IALI,CAKC,qBAAqB,GAArB,CALD,EAMJ,IANI,CAMC,YAAY,IAAI,IAAhB,CAND,EAOJ,IAPI,CAOC,kBAAkB,GAAlB,CAPD,EAQJ,KARI,CAQE,YAAY,GAAZ,CARF,CAAP;AASD;;AAED;AACO,SAAS,OAAT,CAAiB,GAAjB,EAAsB,GAAtB,EAA2B;AAChC,SAAO,YAAK,IAAL,CAAU;AACb,WAAO;AACL,WAAK,IAAI,MAAJ,CAAW;AADX;AADM,GAAV,EAKJ,IALI,CAKC,qBAAqB,GAArB,CALD,EAMJ,IANI,CAMC,aAAa,GAAb,CAND,EAOJ,KAPI,CAOE,YAAY,GAAZ,CAPF,CAAP;AAQD;;AAED;AACO,SAAS,KAAT,CAAe,GAAf,EAAoB,GAApB,EAAyB;AAC9B;AACA;AACA;AACA,MAAI,CAAC,IAAI,IAAT,EAAe,OAAO,YAAY,GAAZ,EAAiB,GAAjB,EAAsB,EAAC,SAAS,aAAV,EAAtB,CAAP;AACf,SAAO,YAAK,IAAL,CAAU;AACf,WAAO,EAAC,UAAU,IAAI,IAAJ,CAAS,QAApB,EADQ;AAEf,aAAS,CAAC,EAAC,qBAAD,EAAD;AAFM,GAAV,EAGJ,IAHI,CAGC,UAAC,IAAD,EAAS;AACf,QAAM,mBAAmB;AACvB,cAAQ,MADe;AAEvB,WAAQ,sBAAO,MAAf,iBAFuB;AAGvB,eAAS;AACP,wBAAgB;AADT,OAHc;AAMvB,YAAM;AACJ,cAAM,UADF;AAEJ,cAAM;AAFF,OANiB;AAUvB,YAAM;AACJ,oBAAY,UADR;AAEJ,kBAAU,IAAI,IAAJ,CAAS,QAFf;AAGJ,kBAAU,IAAI,IAAJ,CAAS;AAHf;AAViB,KAAzB;AAgBA,OAAG,gBAAH,EAAqB,IAArB,CAA0B,UAAC,IAAD,EAAS;AACjC,aAAO,IAAI,IAAJ,CAAS,IAAT,CAAP;AACD,KAFD,EAEG,KAFH,CAES,UAAC,GAAD,EAAQ;AACf,aAAO,IAAI,MAAJ,CAAW,GAAX,EAAgB,IAAhB,CAAqB,GAArB,CAAP;AACD,KAJD;AAKD,GAzBM,EAyBJ,KAzBI,CAyBE,UAAC,GAAD,EAAQ;AACf,YAAQ,GAAR,CAAY,GAAZ;AACA,WAAO,IAAI,MAAJ,CAAW,GAAX,EAAgB,IAAhB,CAAqB,GAArB,CAAP;AACD,GA5BM,CAAP;AA6BD;AACM,SAAS,QAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B;AACjC;AACA;AACA;;AAEA,SAAO,YAAK,MAAL,CACL,IAAI,IADC,EAEL,IAFK,CAEA,UAAC,IAAD,EAAS;AACd,WAAO,IAAI,IAAJ,CAAS,IAAT,CAAP;AACD,GAJM,EAIJ,KAJI,CAIE,UAAC,GAAD,EAAQ;AACf,YAAQ,GAAR,CAAY,GAAZ;AACA,WAAO,IAAI,MAAJ,CAAW,GAAX,EAAgB,IAAhB,CAAqB,cAArB,CAAP;AACD,GAPM,CAAP;AAQD;;AAEM,SAAS,MAAT,CAAgB,GAAhB,EAAqB,GAArB,EAA0B;AAC/B,SAAO,YAAK,OAAL,CAAa;AAChB,aAAS,CAAC,EAAC,qBAAD,EAAgB,OAAO,EAAC,cAAa,CAAd,EAAvB,EAAD;AADO,GAAb,EAGJ,IAHI,CAGC,kBAAkB,GAAlB,CAHD,EAIJ,KAJI,CAIE,YAAY,GAAZ,CAJF,CAAP;AAKD;;AAEM,SAAS,MAAT,CAAgB,GAAhB,EAAqB,GAArB,EAA0B;AAC/B,SAAO,YAAK,OAAL,CAAa;AAChB,aAAS,CAAC,EAAC,qBAAD,EAAgB,OAAO,EAAC,cAAa,CAAd,EAAvB,EAAD;AADO,GAAb,EAGJ,IAHI,CAGC,kBAAkB,GAAlB,CAHD,EAIJ,KAJI,CAIE,YAAY,GAAZ,CAJF,CAAP;AAKD;;AAED;AACO,SAAS,EAAT,CAAY,GAAZ,EAAiB,GAAjB,EAAsB;AAC3B,SAAO,IAAI,IAAJ,CAAS,IAAI,IAAJ,IAAY,EAAC,SAAS,gBAAV,EAArB,CAAP;AACD","file":"api/user/user.controller.js","sourcesContent":["/**\r\n * Using Rails-like standard naming convention for endpoints.\r\n * GET     /api/users              ->  index\r\n * POST    /api/users              ->  create\r\n * GET     /api/users/:id          ->  show\r\n * PUT     /api/users/:id          ->  update\r\n * DELETE  /api/users/:id          ->  destroy\r\n */\r\n\r\n'use strict';\r\n\r\nimport _ from 'lodash';\r\nimport config from '../../config/environment';\r\nimport {User, Company} from '../../sqldb';\r\nvar rp = require('request-promise');\r\n\r\nfunction respondWithResult(res, statusCode) {\r\n  statusCode = statusCode || 200;\r\n  return function (entity) {\r\n    if (entity) {\r\n      res.status(statusCode).json(entity);\r\n    }\r\n  };\r\n}\r\n\r\nfunction saveUpdates(updates) {\r\n  return function (entity) {\r\n    return entity.updateAttributes(updates)\r\n      .then(updated => {\r\n        return updated;\r\n      });\r\n  };\r\n}\r\n\r\nfunction removeEntity(res) {\r\n  return function (entity) {\r\n    if (entity) {\r\n      return entity.destroy()\r\n        .then(() => {\r\n          res.status(204).end();\r\n        });\r\n    }\r\n  };\r\n}\r\n\r\nfunction handleEntityNotFound(res) {\r\n  return function (entity) {\r\n    if (!entity) {\r\n      res.status(404).end();\r\n      return null;\r\n    }\r\n    return entity;\r\n  };\r\n}\r\n\r\nfunction handleError(res, statusCode) {\r\n  statusCode = statusCode || 500;\r\n  return function (err) {\r\n    res.status(statusCode).send(err);\r\n  };\r\n}\r\n\r\n// Gets a list of Users\r\nexport function index(req, res) {\r\n  return User.findAll()\r\n    .then(respondWithResult(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Gets a single User from the DB\r\nexport function show(req, res) {\r\n  return User.find({\r\n      where: {\r\n        _id: req.params.id\r\n      }\r\n    })\r\n    .then(handleEntityNotFound(res))\r\n    .then(respondWithResult(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Creates a new User in the DB\r\nexport function create(req, res) {\r\n\r\n  return User.create(req.body)\r\n    .then(respondWithResult(res, 201))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Updates an existing User in the DB\r\nexport function update(req, res) {\r\n  if (req.body._id) {\r\n    delete req.body._id;\r\n  }\r\n  return User.find({\r\n      where: {\r\n        _id: req.params.id\r\n      }\r\n    })\r\n    .then(handleEntityNotFound(res))\r\n    .then(saveUpdates(req.body))\r\n    .then(respondWithResult(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Deletes a User from the DB\r\nexport function destroy(req, res) {\r\n  return User.find({\r\n      where: {\r\n        _id: req.params.id\r\n      }\r\n    })\r\n    .then(handleEntityNotFound(res))\r\n    .then(removeEntity(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Creates a new User in the DB\r\nexport function login(req, res) {\r\n  //console.log(req.params);\r\n  //console.log(req.query);\r\n  //console.log(req.body);\r\n  if (!req.body) return handleError(res, 400, {message: \"Bad Request\"})\r\n  return User.find({\r\n    where: {username: req.body.username},\r\n    include: [{model: Company}]\r\n  }).then((user)=> {\r\n    const oAuthChatOptions = {\r\n      method: 'POST',\r\n      url: `${config.DOMAIN}/oauth/token`,\r\n      headers: {\r\n        'content-type': 'application/x-www-form-urlencoded'\r\n      },\r\n      auth: {\r\n        user: 'accounts',\r\n        pass: 'accountssecret',\r\n      },\r\n      form: {\r\n        grant_type: 'password',\r\n        username: req.body.username,\r\n        password: req.body.password,\r\n      }\r\n    };\r\n    rp(oAuthChatOptions).then((body)=> {\r\n      return res.json(body);\r\n    }).catch((err)=> {\r\n      return res.status(500).send(err);\r\n    });\r\n  }).catch((err)=> {\r\n    console.log(err);\r\n    return res.status(500).send(err);\r\n  });\r\n}\r\nexport function register(req, res) {\r\n  //console.log(req.params);\r\n  //console.log(req.query);\r\n  //console.log(req.body);\r\n\r\n  return User.create(\r\n    req.body\r\n  ).then((user)=> {\r\n    return res.json(user);\r\n  }).catch((err)=> {\r\n    console.log(err);\r\n    return res.status(404).json(\"Invalid data\")\r\n  });\r\n}\r\n\r\nexport function client(req, res) {\r\n  return User.findAll({\r\n      include: [{model: Company,where: {user_type_id:2}}]\r\n    })\r\n    .then(respondWithResult(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\nexport function vendor(req, res) {\r\n  return User.findAll({\r\n      include: [{model: Company,where: {user_type_id:3}}]\r\n    })\r\n    .then(respondWithResult(res))\r\n    .catch(handleError(res));\r\n}\r\n\r\n// Gets a list of Users\r\nexport function me(req, res) {\r\n  return res.json(req.user || {message: \"not authorized\"})\r\n}\r\n"],"sourceRoot":"/source/"}